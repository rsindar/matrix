---
- name: Install required packages (RHEL/AlmaLinux/Rocky)
  ansible.builtin.yum:
    name:
      - coturn
      - acl
    state: present
  when: ansible_os_family == "RedHat"

- name: Install required packages (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - coturn
      - acl
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Copy Coturn configuration
  ansible.builtin.template:
    src: turnserver.conf.j2
    dest: /etc/coturn/turnserver.conf
    mode: "0640"
    owner: root
    group: coturn
  notify: Restart coturn

- name: Start Coturn service
  ansible.builtin.systemd:
    name: coturn.service
    state: started
    enabled: true

- name: Grant read access to /var/lib/caddy/.local and subdirectories
  ansible.posix.acl:
    path: /var/lib/caddy/.local
    default: true
    recursive: true
    entity: coturn
    etype: user
    permissions: rx
    state: present

- name: Grant read access to Caddy certificate
  ansible.posix.acl:
    path: /var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/{{ matrix_fqdn }}/{{ matrix_fqdn }}.{{ item }}
    entity: coturn
    etype: user
    permissions: r
    state: present
  loop:
    - crt
    - key
